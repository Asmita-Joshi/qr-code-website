<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Authentication</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script type="module" src="firebase.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h2>Scan QR Code to Authenticate</h2>
    <div id="qrcode"></div>
    <p id="status">Waiting for scan...</p>

    <script type="module">
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { db } from "./firebase.js";

        let sessionId = localStorage.getItem("sessionId") || "session-" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("sessionId", sessionId);

        let authURL = `https://Asmita-Joshi.github.io/qr-code-website/Authenticate.html?session=${sessionId}`;

        // Generate QR Code
        new QRCode(document.getElementById("qrcode"), {
            text: authURL,
            width: 256,
            height: 256
        });

        const docRef = doc(db, "sessions", sessionId);

        // Listen for authentication updates in Firestore
        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                let status = docSnap.data().status;

                if (status === "authenticated") {
                    localStorage.setItem("authenticated", "true");
                    document.getElementById("status").innerText = "✅ Authentication Successful!";
                    setTimeout(() => window.location.href = "https://Asmita-Joshi.github.io/qr-code-website/thank-you.html", 2000);
                }
                else if (status === "closed") {
                    // Reset session and reload scanner page when mobile closes
                    localStorage.removeItem("authenticated");
                    localStorage.removeItem("sessionId");
                    window.location.reload();
                }
            }
        });

        // Store initial session in Firestore
        async function createSession() {
            await setDoc(docRef, { status: "waiting" });
        }

        createSession();
    </script>
</body>
</html>
